<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grading Results - AI Grading Studio</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <style>
        .results-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .student-details h1 {
            margin: 0 0 10px 0;
            font-size: 2.2em;
        }

        .student-details p {
            margin: 5px 0;
            opacity: 0.9;
        }

        .score-badge {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .score-number {
            font-size: 3em;
            font-weight: bold;
            margin: 0;
        }

        .score-text {
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
        }

        .stat-label {
            color: #666;
            margin: 5px 0 0 0;
            font-weight: 500;
        }

        .questions-container {
            display: grid;
            gap: 25px;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .question-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
        }

        .question-title {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }

        .question-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            background: #f8f9fa;
        }

        .question-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin: 0;
            flex: 1;
        }

        .grade-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 120px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
        }

        .grade-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border-radius: 25px;
            font-weight: bold;
            color: white;
            font-size: 1em;
            min-width: 90px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .edit-grade-btn {
            padding: 6px 12px;
            font-size: 0.75em;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid #ffc107;
            background-color: #ffc107;
            color: #000;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .edit-grade-btn:hover {
            background-color: #ffb300;
            border-color: #ffb300;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .edit-grade-btn:active {
            transform: translateY(0);
        }

        .grade-edit-container {
            display: none;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .grade-edit-input {
            width: 60px;
            padding: 4px 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
        }

        .grade-edit-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }

        .grade-edit-buttons {
            display: flex;
            gap: 5px;
        }

        .save-grade-btn {
            padding: 4px 8px;
            font-size: 0.7em;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            border: 1px solid #28a745;
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }

        .save-grade-btn:hover {
            background-color: #218838;
            border-color: #218838;
        }

        .cancel-grade-btn {
            padding: 4px 8px;
            font-size: 0.7em;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            border: 1px solid #6c757d;
            background-color: #6c757d;
            color: white;
            cursor: pointer;
        }

        .cancel-grade-btn:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }

        .grade-excellent { background: #10b981; }
        .grade-good { background: #3b82f6; }
        .grade-average { background: #f59e0b; }
        .grade-poor { background: #ef4444; }

        .similarity-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .similarity-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .similarity-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }

        .question-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 25px;
            min-height: 300px;
        }

        .answer-section {
            position: relative;
            background: #fff;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .answer-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .answer-key-section {
            border-color: #10b981;
        }

        .student-answer-section {
            border-color: #3b82f6;
        }

        .answer-header {
            padding: 15px 20px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-key-header {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .student-answer-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .answer-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #374151;
        }

        .label-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
        }

        .answer-key-icon { background: #10b981; }
        .student-answer-icon { background: #3b82f6; }

        .question-text {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-style: italic;
            color: #475569;
        }

        .answer-text {
            line-height: 1.7;
            color: #374151;
            padding: 20px;
            background: #fefefe;
            min-height: 140px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
        }

        .answer-key-text {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }

        .student-answer-text {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }

        .similarity-details {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .similarity-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .similarity-row:last-child {
            margin-bottom: 0;
        }

        .similarity-label {
            font-weight: 500;
            color: #374151;
        }

        .similarity-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .structure-highlights {
            margin-top: 15px;
        }

        .highlight-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 4px;
            font-size: 0.85em;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .highlight-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .highlight-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .structure-components {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .structure-components h6 {
            margin-bottom: 10px;
            color: #3b82f6;
        }

        .component-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .component-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 0.9em;
        }

        .component-key {
            font-weight: 600;
            color: #374151;
        }

        .component-value {
            color: #6b7280;
            font-family: monospace;
        }

        .highlight-tags {
            margin-top: 10px;
        }

        .structure-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .structure-breakdown h6 {
            margin-bottom: 10px;
            color: #3b82f6;
            font-weight: 600;
        }

        .structure-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .structure-component {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .component-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        .component-text {
            color: #6b7280;
            line-height: 1.5;
            font-size: 0.95em;
        }

        .answer-key-structure-breakdown {
            border-left-color: #10b981;
        }

        .answer-key-structure-breakdown h6 {
            color: #10b981;
        }

        .highlight-tags {
            margin-top: 10px;
        }

        .structure-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .structure-component {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .answer-key-structure-breakdown .structure-component {
            border-left-color: #10b981;
        }

        .component-label {
            font-weight: 600;
            color: #3b82f6;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            display: block;
        }

        .answer-key-structure-breakdown .component-label {
            color: #10b981;
        }

        .component-text {
            color: #4b5563;
            line-height: 1.4;
            font-size: 0.9em;
        }



        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #6b7280;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #4b5563;
            transform: translateX(-2px);
            color: white;
            text-decoration: none;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .question-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .student-info {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>AI Grading Studio</h2>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html">Dashboard</a>
            <a href="/analytics.html">Analytics</a>
            <a href="/profile.html">Profile</a>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <main class="results-container">
        <a href="/evaluation.html" class="back-button" id="backButton">
            <i class="fas fa-arrow-left me-2"></i>Back to Evaluation
        </a>

        <div id="loadingIndicator" class="loading-skeleton" style="height: 200px; border-radius: 12px; margin-bottom: 30px;"></div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <div id="resultsContent" style="display: none;">
            <!-- Student Header -->
            <div class="student-header">
                <div class="student-info">
                    <div class="student-details">
                        <h1 id="studentName">Student Name</h1>
                        <p><strong>Student ID:</strong> <span id="studentId"></span></p>
                        <p><strong>Submission ID:</strong> <span id="submissionId"></span></p>
                        <p><strong>Total Questions:</strong> <span id="totalQuestions"></span></p>
                    </div>
                    <div class="score-badge">
                        <div class="score-number" id="finalScore">--</div>
                        <p class="score-text">Final Score</p>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalScoreDisplay">--</div>
                    <p class="stat-label">Total Score</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="percentageDisplay">--%</div>
                    <p class="stat-label">Percentage</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSimilarityDisplay">--</div>
                    <p class="stat-label">Avg Similarity</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="reviewQuestionsDisplay">--</div>
                    <p class="stat-label">Need Review</p>
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer" class="questions-container">
                <!-- Questions will be populated here -->
            </div>
        </div>
    </main>

    <script src="/static/js/auth.js"></script>
    <script>
        let courseworkId, studentId;

        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            courseworkId = params.get('coursework');
            studentId = params.get('student');
            
            console.log('URL parameters:', {courseworkId, studentId});
            console.log('Current URL:', window.location.href);
            console.log('Search params:', window.location.search);
            
            if (!courseworkId || !studentId) {
                showError('Missing required parameters');
                return false;
            }
            return true;
        }

        // Load student results
        async function loadResults() {
            if (!getUrlParams()) return;

            try {
                const apiUrl = `/api/results/${courseworkId}/${studentId}/detailed`;
                console.log('Making API call to:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'include',  // Include cookies for authentication
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API Response status:', response.status);
                console.log('API Response headers:', [...response.headers.entries()]);

                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response received:', textResponse.substring(0, 500));
                    throw new Error(`Server returned ${response.status}: ${response.statusText}. Expected JSON but got ${contentType || 'unknown content type'}`);
                }

                if (!response.ok) {
                    try {
                        const error = await response.json();
                        throw new Error(error.detail || error.error || 'Failed to load results');
                    } catch (jsonError) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                }

                const data = await response.json();
                
                // Debug: Log the received data structure
                console.log('Received data from API:', data);
                console.log('Data keys:', Object.keys(data));
                console.log('Grading summary:', data.grading_summary);
                console.log('Grading summary keys:', data.grading_summary ? Object.keys(data.grading_summary) : 'undefined');
                
                displayResults(data);
                
            } catch (error) {
                console.error('Error loading results:', error);
                // Handle different types of errors
                if (error.message.includes('401') || error.message.includes('Not authenticated')) {
                    showError('You need to be logged in to view results. Please log in and try again.');
                } else if (error.message.includes('404')) {
                    showError('Results not found. Please make sure the assignment has been graded.');
                } else if (error.message.includes('JSON')) {
                    showError('There was an issue with the server response. Please try refreshing the page.');
                } else {
                    showError(`Error loading results: ${error.message}`);
                }
            }
        }

        // Helper function to create answer key structure display
        function getAnswerKeyStructure(result) {
            // Use the expected_structure_components from the API if available
            if (result.expected_structure_components && result.expected_structure_components.length > 0) {
                return result.expected_structure_components.map(comp => `
                    <div class="structure-component">
                        <span class="component-label">${comp.label.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <div class="component-text">${comp.content}</div>
                    </div>
                `).join('');
            }
            
            // Fallback to parsing the expected answer text if no structure components are available
            const answerKeyText = result.expected_answer || '';
            if (!answerKeyText.trim()) {
                return `
                    <div class="structure-component">
                        <span class="component-label">No Structure Available</span>
                        <div class="component-text">Expected answer structure not available.</div>
                    </div>
                `;
            }
            
            const sentences = answerKeyText.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            let components = [];
            sentences.forEach((sentence) => {
                const trimmed = sentence.trim();
                if (trimmed.length > 0) {
                    // Try to identify component types based on keywords and patterns
                    let componentType = 'main point';
                    let componentColor = '#10b981';
                    
                    const lowerText = trimmed.toLowerCase();
                    
                    if (lowerText.includes('shows') || lowerText.includes('demonstrates') || lowerText.includes('illustrates')) {
                        componentType = 'evidence';
                    } else if (lowerText.includes('suggests') || lowerText.includes('implies') || lowerText.includes('indicates')) {
                        componentType = 'implication';
                    } else if (lowerText.includes('because') || lowerText.includes('since') || lowerText.includes('due to')) {
                        componentType = 'reasoning';
                    } else if (lowerText.includes('therefore') || lowerText.includes('thus') || lowerText.includes('hence')) {
                        componentType = 'conclusion';
                    } else if (lowerText.includes('highlights') || lowerText.includes('emphasizes')) {
                        componentType = 'key theme';
                    } else if (lowerText.includes('contrasts') || lowerText.includes('compares') || lowerText.includes('versus')) {
                        componentType = 'comparison';
                    }
                    
                    components.push({
                        type: componentType,
                        text: trimmed
                    });
                }
            });
            
            if (components.length === 0) {
                return `
                    <div class="structure-component">
                        <span class="component-label">Main Content</span>
                        <div class="component-text">${answerKeyText}</div>
                    </div>
                `;
            }
            
            return components.map(comp => `
                <div class="structure-component">
                    <span class="component-label">${comp.type}</span>
                    <div class="component-text">${comp.text}</div>
                </div>
            `).join('');
        }

        // Helper function to create student structure display
        function getStudentStructure(studentStructureComponents) {
            if (!studentStructureComponents || studentStructureComponents.length === 0) {
                return '<div class="structure-component"><span class="component-label">No Structure Detected</span><div class="component-text">Unable to identify structural components in the student answer.</div></div>';
            }
            
            return studentStructureComponents.map(comp => {
                // Clean up the component label for better display
                let cleanLabel = comp.label.replace(/_/g, ' ').toLowerCase();
                cleanLabel = cleanLabel.charAt(0).toUpperCase() + cleanLabel.slice(1);
                
                return `
                    <div class="structure-component">
                        <span class="component-label">${cleanLabel}</span>
                        <div class="component-text">${comp.content || 'No content detected'}</div>
                    </div>
                `;
            }).join('');
        }

        // Display results
        function displayResults(data) {
            // Debug: Log what we're trying to display
            console.log('displayResults called with:', data);
            console.log('data.grading_summary:', data.grading_summary);
            
            // Hide loading, show content
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';

            // Populate student info
            document.getElementById('studentName').textContent = data.student_name || 'Unknown';
            document.getElementById('studentId').textContent = data.student_id || 'Unknown';
            document.getElementById('submissionId').textContent = data.submission_id || 'Unknown';
            document.getElementById('totalQuestions').textContent = data.total_questions || 0;

            // Populate summary with safe access
            const summary = data.grading_summary || {};
            console.log('Summary object:', summary);
            console.log('Summary keys:', Object.keys(summary));
            
            // Safe access to summary properties
            const totalScore = summary.total_score || 0;
            const maxScore = summary.max_possible_score || 0;
            const percentage = summary.percentage || 0;
            const avgSimilarity = summary.average_similarity || 0;
            const reviewQuestions = summary.questions_needing_review || 0;
            
            console.log('Extracted values:', {totalScore, maxScore, percentage, avgSimilarity, reviewQuestions});
            
            document.getElementById('totalScoreDisplay').textContent = `${totalScore}/${maxScore}`;
            document.getElementById('percentageDisplay').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('avgSimilarityDisplay').textContent = (avgSimilarity * 100).toFixed(1) + '%';
            document.getElementById('reviewQuestionsDisplay').textContent = reviewQuestions;
            document.getElementById('finalScore').textContent = `${percentage.toFixed(1)}%`;

            // Populate questions
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            // Use detailed_results if available, otherwise fall back to results
            const resultsData = data.detailed_results || data.results || [];
            
            resultsData.forEach((result, index) => {
                const questionCard = createQuestionCard(result, index + 1);
                container.appendChild(questionCard);
            });
        }

        // Create question card
        function createQuestionCard(result, questionNumber) {
            // Use final_grade if available, otherwise use predicted_grade
            const grade = result.final_grade || parseInt(result.predicted_grade) || 0;
            const gradeClass = grade >= 9 ? 'grade-excellent' : 
                             grade >= 7 ? 'grade-good' : 
                             grade >= 5 ? 'grade-average' : 'grade-poor';

            const similarity = result.similarity_scores?.full_similarity || 0;
            const similarityPercent = (similarity * 100).toFixed(1);

            console.log(`Creating question card ${questionNumber} with grade ${grade}`);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.innerHTML = `
                <div class="question-header">
                    <h3 class="question-title">Question ${questionNumber}</h3>
                    <div class="similarity-indicator">
                        <span>${similarityPercent}%</span>
                        <div class="similarity-bar">
                            <div class="similarity-fill" style="width: ${similarityPercent}%"></div>
                        </div>
                    </div>
                    <div class="grade-section">
                        <div class="grade-badge ${gradeClass}" id="grade-badge-${questionNumber}">
                            <span id="grade-${questionNumber}">${result.predicted_grade}/10</span>
                            ${result.grade_edited ? '<i class="fas fa-pencil-alt ms-1" title="Grade manually edited"></i>' : ''}
                        </div>
                        <button class="edit-grade-btn" 
                                id="edit-btn-${questionNumber}"
                                onclick="showGradeEdit(${questionNumber}, '${result.question_id}', ${result.predicted_grade})"
                                title="Edit Grade">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <div class="grade-edit-container" id="grade-edit-${questionNumber}">
                            <input type="number" class="grade-edit-input" 
                                   id="grade-input-${questionNumber}"
                                   min="0" max="10" step="0.1" 
                                   placeholder="0-10"
                                   onkeypress="handleGradeKeyPress(event, ${questionNumber}, '${result.question_id}')">
                            <div class="grade-edit-buttons">
                                <button class="save-grade-btn" 
                                        onclick="saveInlineGrade(${questionNumber}, '${result.question_id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="cancel-grade-btn" 
                                        onclick="cancelGradeEdit(${questionNumber})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="question-content">
                    <div class="answer-section answer-key-section">
                        <div class="answer-header answer-key-header">
                            <i class="fas fa-key"></i>
                            <span>Expected Answer</span>
                        </div>
                        <div class="question-text">${result.question_text}</div>
                        <div class="answer-text answer-key-text">${result.expected_answer || 'No expected answer available'}</div>
                        
                        <div class="structure-breakdown answer-key-structure-breakdown">
                            <h6 class="mb-3"><i class="fas fa-bullseye me-2"></i>Expected Structure Components</h6>
                            <div class="structure-content">
                                ${getAnswerKeyStructure(result)}
                            </div>
                        </div>
                    </div>
                    <div class="answer-section student-answer-section">
                        <div class="answer-header student-answer-header">
                            <i class="fas fa-user-graduate"></i>
                            <span>Student Answer</span>
                        </div>
                        <div class="answer-text student-answer-text">${result.student_answer || 'No answer provided'}</div>
                        
                        ${result.student_structure_components && result.student_structure_components.length > 0 ? `
                            <div class="structure-breakdown">
                                <h6 class="mb-3"><i class="fas fa-sitemap me-2"></i>Detected Structure Components</h6>
                                <div class="structure-content">
                                    ${getStudentStructure(result.student_structure_components)}
                                </div>
                            </div>
                        ` : `
                            <div class="structure-breakdown">
                                <h6 class="mb-3" style="color: #dc3545;"><i class="fas fa-exclamation-triangle me-2"></i>No Structure Components Detected</h6>
                                <div class="structure-content">
                                    <div class="structure-component">
                                        <span class="component-label">No Structure Detected</span>
                                        <div class="component-text">Unable to identify structural components in the student answer.</div>
                                    </div>
                                </div>
                            </div>
                        `}
                        
                        <div class="similarity-details">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="similarity-row">
                                        <span class="similarity-label">
                                            <i class="fas fa-chart-line me-2"></i>Overall Similarity
                                        </span>
                                        <span class="similarity-value">${(result.similarity_scores.full_similarity * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="similarity-row">
                                        <span class="similarity-label">
                                            <i class="fas fa-search me-2"></i>Content Match
                                        </span>
                                        <span class="similarity-value">${(result.similarity_scores.tfidf_similarity * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="similarity-row">
                                        <span class="similarity-label">
                                            <i class="fas fa-sitemap me-2"></i>Structure Match
                                        </span>
                                        <span class="similarity-value">${(result.similarity_scores.structure_similarity * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="similarity-row">
                                        <span class="similarity-label">
                                            <i class="fas fa-puzzle-piece me-2"></i>Components
                                        </span>
                                        <span class="similarity-value">${result.structure_components}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    ${result.spans && result.spans.length > 0 ? `
                                        <div class="structure-highlights">
                                            <h6><i class="fas fa-tags me-2"></i>Detected Concepts</h6>
                                            <div class="highlight-tags">
                                                ${result.spans.map(span => `<span class="highlight-tag">${span.label}</span>`).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${result.requires_llm_evaluation && result.requires_llm_evaluation.length > 0 ? `
                                        <div class="alert alert-warning mt-3">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <small><strong>Manual Review Required:</strong><br>
                                            ${result.requires_llm_evaluation.join(', ')}</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ${result.grade_explanation || 'Grade assigned based on similarity analysis'}
                                </small>
                            </div>
                        </div>
                        

                    </div>
                </div>
            `;
            return card;
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Get auth token
        function getAuthToken() {
            // For now, we'll rely on cookies for auth
            return '';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
            
            // Set up back button - simple approach
            const backButton = document.getElementById('backButton');
            if (backButton) {
                console.log('Back button found');
                // Remove any existing event listeners and let the href handle navigation
                backButton.onclick = null;
            } else {
                console.error('Back button not found');
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Inline Grade Edit Functionality
        function handleGradeKeyPress(event, questionNumber, questionId) {
            if (event.key === 'Enter') {
                saveInlineGrade(questionNumber, questionId);
            } else if (event.key === 'Escape') {
                cancelGradeEdit(questionNumber);
            }
        }

        function showGradeEdit(questionNumber, questionId, currentGrade) {
            // Hide the edit button
            document.getElementById(`edit-btn-${questionNumber}`).style.display = 'none';
            
            // Show the edit container
            const editContainer = document.getElementById(`grade-edit-${questionNumber}`);
            editContainer.style.display = 'flex';
            
            // Set the current grade in the input
            document.getElementById(`grade-input-${questionNumber}`).value = currentGrade;
            
            // Focus on the input
            document.getElementById(`grade-input-${questionNumber}`).focus();
            document.getElementById(`grade-input-${questionNumber}`).select();
        }

        function cancelGradeEdit(questionNumber) {
            // Hide the edit container
            document.getElementById(`grade-edit-${questionNumber}`).style.display = 'none';
            
            // Show the edit button
            document.getElementById(`edit-btn-${questionNumber}`).style.display = 'block';
        }

        async function saveInlineGrade(questionNumber, questionId) {
            const newGradeInput = document.getElementById(`grade-input-${questionNumber}`);
            const newGrade = parseFloat(newGradeInput.value);
            
            if (isNaN(newGrade) || newGrade < 0 || newGrade > 10) {
                alert('Please enter a valid grade between 0 and 10');
                newGradeInput.focus();
                return;
            }
            
            try {
                const response = await fetch('/api/results/edit-grade', {
                    method: 'POST',
                    credentials: 'include',  // Include cookies for authentication
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        coursework_id: courseworkId,
                        student_id: studentId,
                        question_id: questionId,
                        old_grade: parseFloat(document.getElementById(`grade-${questionNumber}`).textContent.split('/')[0]),
                        new_grade: newGrade,
                        reason: `Grade updated via inline edit to ${newGrade}`
                    })
                });
                
                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response received:', textResponse.substring(0, 500));
                    throw new Error(`Server returned ${response.status}: ${response.statusText}. Expected JSON but got ${contentType || 'unknown content type'}`);
                }
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Check if the response indicates success
                    if (result.success) {
                        // Update the grade display
                        document.getElementById(`grade-${questionNumber}`).textContent = `${newGrade}/10`;
                        
                        // Update the grade badge class
                        const gradeBadge = document.getElementById(`grade-badge-${questionNumber}`);
                        gradeBadge.className = gradeBadge.className.replace(/grade-\w+/, '');
                        const gradeClass = newGrade >= 9 ? 'grade-excellent' : 
                                         newGrade >= 7 ? 'grade-good' : 
                                         newGrade >= 5 ? 'grade-average' : 'grade-poor';
                        gradeBadge.classList.add('grade-badge', gradeClass);
                        
                        // Hide the edit container and show the edit button
                        cancelGradeEdit(questionNumber);
                        
                        // Recalculate totals
                        recalculateScores();
                        
                        // Show success message
                        showSuccessMessage('Grade updated successfully!');
                    } else {
                        alert(`Error updating grade: ${result.error || 'Unknown error'}`);
                    }
                } else {
                    try {
                        const error = await response.json();
                        alert(`Error updating grade: ${error.error || error.detail || 'Unknown error'}`);
                    } catch (jsonError) {
                        alert(`Error updating grade: Server returned ${response.status}: ${response.statusText}`);
                    }
                }
            } catch (error) {
                console.error('Error updating grade:', error);
                if (error.message.includes('401') || error.message.includes('Not authenticated')) {
                    alert('You need to be logged in to edit grades. Please log in and try again.');
                } else if (error.message.includes('JSON')) {
                    alert('There was an issue with the server response. Please try refreshing the page.');
                } else {
                    alert(`Failed to update grade: ${error.message}`);
                }
            }
        }

        function recalculateScores() {
            // Recalculate and update the total scores
            const gradeElements = document.querySelectorAll('[id^="grade-"]');
            let totalScore = 0;
            let questionCount = 0;
            
            gradeElements.forEach(element => {
                const gradeText = element.textContent;
                const grade = parseFloat(gradeText.split('/')[0]);
                if (!isNaN(grade)) {
                    totalScore += grade;
                    questionCount++;
                }
            });
            
            const maxPossibleScore = questionCount * 10;
            const percentage = (totalScore / maxPossibleScore) * 100;
            
            document.getElementById('totalScoreDisplay').textContent = `${totalScore}/${maxPossibleScore}`;
            document.getElementById('percentageDisplay').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('finalScore').textContent = `${percentage.toFixed(1)}%`;
        }

        function showSuccessMessage(message) {
            // Create a temporary success alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
